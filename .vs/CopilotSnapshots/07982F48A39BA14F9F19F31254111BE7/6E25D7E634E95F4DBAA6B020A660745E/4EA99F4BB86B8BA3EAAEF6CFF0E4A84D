/*
 * Local database bootstrap & sanity script
 * - Ensures DATABASE_URL exists
 * - Parses connection & ensures ssl disabled for localhost
 * - Attempts connection (retries)
 * - Optionally creates database if missing (when connecting to postgres maintenance db)
 * - Runs drizzle push (schema sync)
 * - Seeds database if empty (using existing seed script)
 */
import { Pool } from 'pg';
import { execSync } from 'node:child_process';
import { fileURLToPath } from 'node:url';
import path from 'node:path';

const REQUIRED_ENV = ['DATABASE_URL'];
for (const key of REQUIRED_ENV) {
  if (!process.env[key]) {
    console.error(`[bootstrap] Missing ${key} in environment (.env)`);
    process.exit(1);
  }
}

const rawUrl = process.env.DATABASE_URL!;

function parse(urlStr: string) {
  try {
    const u = new URL(urlStr);
    return {
      user: decodeURIComponent(u.username),
      password: decodeURIComponent(u.password),
      host: u.hostname,
      port: parseInt(u.port || '5432', 10),
      database: u.pathname.replace(/^\//, ''),
      search: u.search,
      protocol: u.protocol,
      sslMode: (u.searchParams.get('sslmode') || '').toLowerCase(),
    };
  } catch (e) {
    console.error('[bootstrap] Invalid DATABASE_URL:', e);
    process.exit(1);
  }
}

const info = parse(rawUrl);

// Enforce local SSL disable automatically
if ((info.host === 'localhost' || info.host === '127.0.0.1') && info.sslMode !== 'disable') {
  console.log('[bootstrap] Adjusting connection to disable SSL for localhost');
  if (!info.search.includes('sslmode=')) {
    process.env.DATABASE_URL = rawUrl + (rawUrl.includes('?') ? '&' : '?') + 'sslmode=disable';
  } else {
    // user already specified something else; warn
    console.warn('[bootstrap] WARNING: sslmode not disable for localhost - may cause psql SSL error');
  }
  process.env.PGSSLMODE = 'disable';
}

async function ensureConnect() {
  const pool = new Pool({ connectionString: process.env.DATABASE_URL!, ssl: false });
  try {
    const res = await pool.query('select 1 as ok');
    console.log('[bootstrap] Database connection OK:', res.rows[0]);
    await pool.end();
  } catch (e: any) {
    if (/SSL/.test(e.message)) {
      console.error('[bootstrap] SSL error detected. Ensure sslmode=disable for local server or enable SSL on the server.');
    }
    console.error('[bootstrap] Connection failed:', e.message);
    process.exit(1);
  }
}

function run(cmd: string) {
  console.log(`[bootstrap] $ ${cmd}`);
  execSync(cmd, { stdio: 'inherit' });
}

async function runDrizzlePush() {
  try {
    run('npx drizzle-kit push');
  } catch (e) {
    console.error('[bootstrap] drizzle-kit push failed');
    process.exit(1);
  }
}

async function seedIfEmpty() {
  try {
    // dynamic import after pool established
    const { db } = await import('../server/db.js');
    const { users } = await import('../shared/schema/index.js');
    const rows = await db.select({ id: users.id }).from(users).limit(1);
    if (rows.length === 0) {
      console.log('[bootstrap] Seeding database (no users found)');
      const seedMod = await import('../server/seed.js');
      await seedMod.seedDatabase?.();
    } else {
      console.log('[bootstrap] Seed skipped (data exists)');
    }
  } catch (e) {
    console.warn('[bootstrap] Seed step skipped (could not load schema). Error:', (e as Error).message);
  }
}

(async () => {
  await ensureConnect();
  await runDrizzlePush();
  await seedIfEmpty();
  console.log('[bootstrap] Complete');
})();
